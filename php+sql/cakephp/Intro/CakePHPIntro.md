## CakePHP概要

CakePHPはウェブ開発を単純に簡単にできるように開発された

オールインワンのツールボックスはいろいろなパーツが一緒に動いたり、バラバラに動いたりできるようにする

この概要の目的は、CakePHPの一般的なコンセプトとそのコンセプトがどのようにCakePHPの中で働くのかを紹介することです。

## 設定より規約
CakePHPは基礎的な構造をクラス名、ファイル名、DBのテーブル名や他の規約から決定する。

規約を学ぶことで、不必要な設定や他の一般的なアプリと同じ構造をいちいち書かなくて済むので、簡単にいろいろなプロジェキトを進めることができる

この規約はいろいろなCakePHPで使う規約をカバーしている

## モデル層
モデル層はビジネスロジックを実装するアプリケーションの部品を表します。アプリケーションにおいてデータを取得し、それを最初の意味ある形に変換する役割を担う。

これには、加工、検証、関連付け、あるいはデータの処理に関係のあるその他のタスクが含まれます。

ソーシャルネットワークの場合では、モデルそうはユーザーのデータの保存、友人の繋がりの保存、ユーザーの写真の保管と取得、新しい友人候補の検出などのタスクを引き受けることでしょう。この時、モデルオブジェクトは「友達」「ユーザー」「コメント」あるいは「写真」と考えることができます。

もしusersテーブルからデータを読み出したいのであれば次のようになります。

```
use Cake\ORM\TableRegistry;

// Prior to 3.6 use TableRegistry::get('Users')
$users = TableRegistry::getTableLocator()->get('Users');
$query = $users->find();
foreach ($query as $row) {
    echo $row->username;
}

```

データの処理を始める前に一切コードを書く必要が無かったことに気付いたかもしれません。

規約を使うことによって、CakePHPはテーブルとエンティティーのクラスを定義していない場合には標準のクラスを使用する。

新しいユーザーを作成し、それを（検証して）保存したい場合には次のようにします

```
use Cake\ORM\TableRegistry;

// Prior to 3.6 use TableRegistry::get('Users')
$users = TableRegistry::getTableLocator()->get('Users');
$query = $users->find();
foreach ($query as $row) {
    echo $row->username;
}
```

データの処理を始める前に一切コードを書く必要が無かったことに気付いたかもしれません。
規約を使うことによって、CakePHPはテーブルとエンティティのクラスを定義していない場合には標準のクラスを使用します。

新しいユーザを作成し、それを（検証して）保存したい場合は次のようにします

```
use Cake\ORM\TableRegistry;

// Prior to 3.6 use TableRegistry::get('Users')
$users = TableRegistry::getTableLocator()->get('Users');
$user = $users->newEntity(['email' => 'mark@example.com]);
$users->save($user);
```

## ビュー層
ビュー層は、モデルから来たデータをレンダリングします。
ビューはモデルオブジェクトとは別に存在する。
そして扱っている情報に対してレスポンシブルナアプリケーションが必要としている表示インターフェースを全て提供可能です。

例えば、このビューはモデルのデータを利用してHTMLビューテンプレートや他で利用するためのXML形式の結果をレンダリングできます

* レンダリング
表示用のデータを元に、内容を整形して表示すること
元となるデータがあり
元となるデータを整形して
整形した結果を表示する

```
// ビューテンプレートファイルで'element'をそれぞれのユーザーに対してレンダリングすっる
<?php foreach ($users as $user): ?>
    <li class="user">
        <?= $this->element('user_info', ['user' => $user]) ?>
<?php endforeach; ?>
```

このビュー層はビューテンプレートやエレメントやビューセルのような仕組みで表示のためのロジックを再利用可能にして、たくさんの表示を拡張するための機能を提供する。

ビュー層はHTMLやテキストのレンダリングを制御できるだけではなく、一般的なJSONやXML、加えてプラグインで追加可能なアーキテクチャによるフォーマットなら何にでも対応します

## コントローラー層

コントローラー層はユーザーからのリクエストを扱います。
これはモデルそうとビュー層の助けを借りてレスポンスをレンダリングして返す責任を置います。

コントローラーは、タスクを終えるための全ての必要とされるリソースが正しい労働者に移譲されることに注意を払うマネージャーと見ることができます。
クライアントからの要求をまち、認証と承認のルールによる検証を行い、データの取得または処理をモデルに移譲し、クライアントが受け入れる適切な表示上のデータの種類を採択し、最終的にその描画処理をビュー層に委譲します。

例えばユーザ登録ではこのようになります。

```
public function add()
{
    $user = $this->Users->newEntity();
    if ($this->request->is('post')) {
        $user = $this->Users->patchEntity($user, $this->request->getData());
        if ($this->Users->save($user, ['validate' => 'registration'])) {
            $this->Flash->success(__('You are now registered.'));
        } else {
            $this->Flash->error(__('There were some problems.'));
        }
    }
    $this->set('user', $user);
}

```

明示的にビューをレンダリングしないことに気づくかもしれません。CakePHPは規約によって正しいビューを選択し、set()で用意したビューデータでそのビューをレンダリングします。

## CakePHPのリクエストサイクル

いろいろなレイヤーに親しんでいただきました。次はリクエストサイクルがどのように働くのか見ていきましょう

![画像](/php+sql/cakephp/Image/typical-cake-request.png)

典型的なCakePHPのリクエストサイクルはユーザがアプリケーション内でページまたはリソースにリクエストを投げるところから始まります。
高位のそれぞれのリクエストは以下のステップで動きます

1. ウェブサーバーがwebroot/index.phpへのリクエストを制御するルールを書き換えます。
2. あなたのアプリケーションがロードされ、HttpServerに紐づきます
3. あなたのアプリケーションのミドルウェアが初期化されます。
4. リクエストとレスポンスは、あなたのアプリケーションで使用するPSR-7ミドルウェアを経由してディスパッチされます。これは、一般的にエラートラップとルーティングを含みます。
5. ミドルウェアからレスポンスが返らない場合やリクエストがルーティング情報を含む場合、コントローラーとアクションが選択されます。
6. コントローラーのアクションが呼ばれ、コントローラが要求されたモデルとコンポーネントと通信します。
7. コントローラーが出力を生成するためにレスポンスの生成をビューに委任します。
8. ビューがヘルパーとセルを使ってボディとヘッダーを生成して返す。
9. レスポンスは、ミドルウェアを経由して送信されます。
10. HttpServerは、ウェブサーバーにレスポンスを送ります